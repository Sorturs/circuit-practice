<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circuit Master: Visual Physics Lab</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #4f46e5;
            --accent: #f59e0b;
            --purple: #9333ea;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f8fafc;
            --text: #1e293b;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h1 { margin: 0; font-size: 1.8rem; }
        p.subtitle { margin: 0.5rem 0 0; opacity: 0.9; }

        /* Navigation */
        nav {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }

        .nav-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid transparent;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            background: transparent;
            color: var(--text);
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
        }

        /* Main Content */
        main {
            flex: 1;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .section { display: none; animation: fadeIn 0.3s ease-in; }
        .section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Concept Cards */
        .concept-card {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--primary);
        }

        .analogy-box {
            background: #eff6ff;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-style: italic;
            border: 1px dashed var(--primary);
        }

        /* Interactive Circuit Area */
        .game-container {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            text-align: center;
        }

        .circuit-visual {
            background: #1e293b; /* Dark board */
            padding: 2rem;
            position: relative;
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        svg {
            width: 100%;
            height: 100%;
            max-width: 600px;
        }

        /* Circuit Elements */
        .wire { stroke: #cbd5e1; stroke-width: 3; fill: none; stroke-linecap: round; }
        .resistor { stroke: #f59e0b; stroke-width: 4; fill: none; stroke-linejoin: round; }
        .battery { stroke: #ef4444; stroke-width: 4; }
        .label-bg { fill: #0f172a; opacity: 0.85; }
        .label-text { fill: #ffffff; font-family: monospace; font-size: 14px; font-weight: bold; }
        .val-text { font-family: sans-serif; font-size: 16px; font-weight: bold; }
        
        /* Dynamic classes */
        .series-mode .wire { stroke: #93c5fd; }
        .parallel-mode .wire { stroke: #c4b5fd; }
        .combo-mode .wire { stroke: #e9d5ff; }

        .controls {
            padding: 2rem;
        }

        .input-group {
            margin: 1.5rem 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            align-items: center;
        }

        input[type="number"] {
            padding: 0.75rem;
            font-size: 1.5rem;
            width: 120px;
            border: 3px solid #e2e8f0;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s;
        }

        input[type="number"]:disabled {
            background-color: #f1f5f9;
            color: #64748b;
        }
        
        input.correct-input { border-color: var(--success); background-color: #dcfce7; color: #166534; }
        input.wrong-input { border-color: var(--danger); background-color: #fee2e2; color: #991b1b; }

        button.action-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1.2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s, opacity 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        button.action-btn:active { transform: scale(0.98); }
        button.action-btn:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; }

        .feedback-area {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            display: none;
            text-align: left;
            border-left: 5px solid transparent;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .feedback-area.correct { background: #f0fdf4; color: #166534; border-color: var(--success); }
        .feedback-area.wrong { background: #fef2f2; color: #991b1b; border-color: var(--danger); }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 2rem;
            background: #f1f5f9;
            font-size: 1rem;
            color: #64748b;
            font-weight: 600;
        }

        #next-btn {
            background: var(--primary);
            margin-top: 1.5rem;
            width: 100%;
            display: none;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); }
            100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
        }
    </style>
</head>
<body>

<header>
    <h1>‚ö° Circuit Master</h1>
    <p class="subtitle">Grade 9 Physics: Series, Parallel & Combination</p>
</header>

<nav>
    <button class="nav-btn active" onclick="switchTab('learn')">üìò Learn Concepts</button>
    <button class="nav-btn" onclick="switchTab('practice')">üéÆ Practice Lab</button>
</nav>

<main>
    <!-- LEARN SECTION -->
    <div id="learn" class="section active">
        
        <!-- Series Concept -->
        <div class="concept-card">
            <h2 style="color: var(--primary);">1. The Series Circuit (The Single Loop)</h2>
            <p>In a series circuit, current flows in <strong>one single path</strong>. There are no junctions.</p>
            
            <div style="display:flex; gap: 20px; align-items:center; flex-wrap: wrap;">
                <svg width="250" height="150" viewBox="0 0 250 150" style="background:#1e293b; border-radius:8px;">
                    <rect x="40" y="30" width="170" height="90" class="wire" rx="5" />
                    <!-- Battery Left -->
                    <line x1="40" y1="55" x2="40" y2="95" stroke="#1e293b" stroke-width="10" />
                    <line x1="30" y1="65" x2="50" y2="65" class="battery" />
                    <line x1="35" y1="75" x2="45" y2="75" class="battery" />
                    <line x1="30" y1="85" x2="50" y2="85" class="battery" />
                    <!-- R1 Top -->
                    <line x1="95" y1="30" x2="155" y2="30" stroke="#1e293b" stroke-width="10" />
                    <polyline points="95,30 100,25 110,35 120,25 130,35 140,25 150,35 155,30" class="resistor" />
                    <!-- R2 Bottom -->
                    <line x1="95" y1="120" x2="155" y2="120" stroke="#1e293b" stroke-width="10" />
                    <polyline points="95,120 100,115 110,125 120,115 130,125 140,115 150,125 155,120" class="resistor" />
                </svg>
                <div style="flex:1;">
                    <ul style="list-style: none; padding:0;">
                        <li><strong>‚ö° Current (<b>I</b>):</strong> Constant everywhere. <br><code style="background:#e0e7ff; padding:2px 5px;">I<sub>total</sub> = I<sub>1</sub> = I<sub>2</sub></code></li>
                        <li style="margin-top:10px;"><strong>üîã Voltage (<b>V</b>):</strong> Splits/Adds up. <br><code style="background:#fff7ed; padding:2px 5px;">V<sub>total</sub> = V<sub>1</sub> + V<sub>2</sub></code></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Parallel Concept -->
        <div class="concept-card" style="border-left-color: var(--accent);">
            <h2 style="color: var(--accent);">2. The Parallel Circuit (The Ladder)</h2>
            <p>In a parallel circuit, wires connect to create <strong>multiple independent paths</strong>.</p>
            
            <div style="display:flex; gap: 20px; align-items:center; flex-wrap: wrap;">
                <svg width="250" height="150" viewBox="0 0 250 150" style="background:#1e293b; border-radius:8px;">
                    <!-- Rails -->
                    <line x1="50" y1="30" x2="200" y2="30" class="wire" />
                    <line x1="50" y1="120" x2="200" y2="120" class="wire" />
                    <!-- Battery Left -->
                    <line x1="50" y1="30" x2="50" y2="120" class="wire" />
                    <line x1="50" y1="55" x2="50" y2="95" stroke="#1e293b" stroke-width="10" />
                    <line x1="40" y1="65" x2="60" y2="65" class="battery" />
                    <line x1="45" y1="75" x2="55" y2="75" class="battery" />
                    <line x1="40" y1="85" x2="60" y2="85" class="battery" />
                    <!-- Branch 1 -->
                    <line x1="120" y1="30" x2="120" y2="120" class="wire" />
                    <line x1="120" y1="55" x2="120" y2="95" stroke="#1e293b" stroke-width="10" />
                    <polyline points="120,55 115,60 125,70 115,80 125,90 120,95" class="resistor" />
                    <!-- Branch 2 -->
                    <line x1="190" y1="30" x2="190" y2="120" class="wire" />
                    <line x1="190" y1="55" x2="190" y2="95" stroke="#1e293b" stroke-width="10" />
                    <polyline points="190,55 185,60 195,70 185,80 195,90 190,95" class="resistor" />
                </svg>
                <div style="flex:1;">
                    <ul style="list-style: none; padding:0;">
                        <li><strong>‚ö° Current (<b>I</b>):</strong> Splits/Adds up. <br><code style="background:#e0e7ff; padding:2px 5px;">I<sub>total</sub> = I<sub>1</sub> + I<sub>2</sub></code></li>
                        <li style="margin-top:10px;"><strong>üîã Voltage (<b>V</b>):</strong> Constant everywhere. <br><code style="background:#fff7ed; padding:2px 5px;">V<sub>total</sub> = V<sub>1</sub> = V<sub>2</sub></code></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Combination Concept -->
        <div class="concept-card" style="border-left-color: var(--purple);">
            <h2 style="color: var(--purple);">3. The Combination Circuit (Mix)</h2>
            <p>A mix of both! Some parts are in series, some are in parallel. You must follow the path.</p>
            
            <div style="display:flex; gap: 20px; align-items:center; flex-wrap: wrap;">
                 <svg width="250" height="150" viewBox="0 0 250 150" style="background:#1e293b; border-radius:8px;">
                    <!-- Main Loop -->
                    <line x1="30" y1="30" x2="100" y2="30" class="wire" /> <!-- Top wire to R1 -->
                    <line x1="100" y1="30" x2="100" y2="50" class="wire" /> <!-- Drop to split -->
                    
                    <!-- Parallel Block -->
                    <line x1="100" y1="50" x2="200" y2="50" class="wire" /> <!-- Top Parallel Rail -->
                    <line x1="100" y1="120" x2="200" y2="120" class="wire" /> <!-- Bot Parallel Rail -->
                    
                    <!-- Branches -->
                    <line x1="130" y1="50" x2="130" y2="120" class="wire" />
                    <line x1="170" y1="50" x2="170" y2="120" class="wire" />

                    <!-- Return Loop -->
                    <line x1="100" y1="120" x2="100" y2="135" class="wire" /> 
                    <line x1="30" y1="135" x2="100" y2="135" class="wire" /> 
                    <line x1="30" y1="30" x2="30" y2="135" class="wire" /> 

                    <!-- Battery -->
                    <line x1="30" y1="70" x2="30" y2="100" stroke="#1e293b" stroke-width="10" />
                    <line x1="22" y1="75" x2="38" y2="75" class="battery" />
                    <line x1="26" y1="82" x2="34" y2="82" class="battery" />
                    <line x1="22" y1="90" x2="38" y2="90" class="battery" />
                    
                    <!-- Series Resistor R1 -->
                    <line x1="60" y1="30" x2="90" y2="30" stroke="#1e293b" stroke-width="10" />
                    <polyline points="60,30 62,25 67,35 72,25 77,35 82,25 87,35 90,30" class="resistor" />

                    <!-- Parallel Resistor R2 (Left Branch) -->
                    <line x1="130" y1="65" x2="130" y2="95" stroke="#1e293b" stroke-width="10" />
                    <polyline points="130,65 135,68 125,73 135,78 125,83 135,88 130,90" class="resistor" fill="none"/>

                    <!-- Parallel Resistor R3 (Right Branch) -->
                    <line x1="170" y1="65" x2="170" y2="95" stroke="#1e293b" stroke-width="10" />
                    <polyline points="170,65 175,68 165,73 175,78 165,83 175,88 170,90" class="resistor" fill="none"/>
                </svg>
                <div style="flex:1;">
                    <ul style="list-style: none; padding:0;">
                        <li><strong>At Main Wire (Series Part):</strong> All current must flow here. <br><code style="background:#f3e8ff; padding:2px 5px;">I<sub>total</sub> = I<sub>1</sub></code></li>
                        <li style="margin-top:10px;"><strong>At The Split (Parallel Part):</strong> Current splits between branches. <br><code style="background:#f3e8ff; padding:2px 5px;">I<sub>1</sub> = I<sub>2</sub> + I<sub>3</sub></code></li>
                        <li style="margin-top:10px;"><strong>Voltage Rule:</strong> Total Voltage is shared between the Series part and the Parallel part. <br><code style="background:#fff7ed; padding:2px 5px;">V<sub>total</sub> = V<sub>1</sub> + V<sub>parallel</sub></code></li>
                    </ul>
                </div>
            </div>
             <div class="analogy-box" style="border-color: var(--purple);">
                üõ£Ô∏è <strong>Analogy:</strong> A highway (Series) that splits into a two-lane toll booth (Parallel), then merges back into a highway. All cars drive on the highway, but they split up at the toll booth.
            </div>
        </div>
        
        <button class="action-btn" style="width:100%" onclick="switchTab('practice')">I'm Ready to Practice! ‚Üí</button>
    </div>

    <!-- PRACTICE SECTION -->
    <div id="practice" class="section">
        <div class="game-container">
            <div class="stats-bar">
                <span>Streak: <strong id="streak-display">0</strong> üî•</span>
                <span id="mode-badge">SERIES MODE</span>
            </div>

            <div class="circuit-visual" id="circuit-canvas">
                <!-- SVG injected by JS -->
            </div>

            <div class="controls">
                <h3 id="question-text">Find the missing value (?)</h3>
                
                <div class="input-group">
                    <span style="font-size: 1.5rem; font-weight:bold;" id="input-label">V‚ÇÇ = </span>
                    <input type="number" id="user-input" placeholder="?" onkeydown="if(event.key==='Enter') checkAnswer()">
                    <span style="font-size: 1.2rem; color: #64748b;" id="unit-label">V</span>
                </div>

                <button id="check-btn" class="action-btn" onclick="checkAnswer()">Check Answer</button>

                <div id="feedback-box" class="feedback-area">
                    <!-- Feedback injected here -->
                </div>
                
                <button id="next-btn" class="action-btn" onclick="generateProblem()">Next Challenge ‚Üí</button>
            </div>
        </div>
    </div>
</main>

<script>
    // --- STATE MANAGEMENT ---
    let currentProblem = null;
    let streak = 0;

    // --- NAVIGATION ---
    function switchTab(tabId) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabId).classList.add('active');
        const btns = document.querySelectorAll('.nav-btn');
        if(tabId === 'learn') btns[0].classList.add('active');
        else {
            btns[1].classList.add('active');
            if(!currentProblem) generateProblem();
        }
    }

    // --- HELPER: LABEL GENERATOR ---
    function createLabel(x, y, text, color) {
        const width = text.length * 9 + 10;
        return `
            <rect x="${x - width/2}" y="${y - 12}" width="${width}" height="24" rx="4" class="label-bg" />
            <text x="${x}" y="${y+5}" text-anchor="middle" class="label-text" fill="${color}">${text}</text>
        `;
    }

    // --- SVG GENERATORS ---
    function getSeriesSVG(vals, unknownKey) {
        const getText = (key) => key === unknownKey ? `?` : `${vals[key]}`;
        const vColor = "#f59e0b"; const iColor = "#93c5fd"; const battColor = "#ef4444";

        return `
        <svg viewBox="0 0 400 250">
            <rect x="60" y="40" width="280" height="170" class="wire" rx="10" />
            
            <!-- Battery (Left) -->
            <line x1="60" y1="80" x2="60" y2="170" stroke="#1e293b" stroke-width="10" />
            <line x1="45" y1="100" x2="75" y2="100" class="battery" />
            <line x1="52" y1="115" x2="68" y2="115" class="battery" />
            <line x1="45" y1="130" x2="75" y2="130" class="battery" />
            <line x1="52" y1="145" x2="68" y2="145" class="battery" />
            
            ${vals.vt !== '' ? createLabel(30, 125, `VT=${getText('vt')}`, battColor) : ''}
            ${vals.it !== '' ? createLabel(90, 230, `IT=${getText('it')}`, iColor) : ''}

            <!-- Resistor 1 (Top) -->
            <line x1="160" y1="40" x2="240" y2="40" stroke="#1e293b" stroke-width="10" />
            <polyline points="160,40 165,30 175,50 185,30 195,50 205,30 215,50 225,30 235,50 240,40" class="resistor" />
            ${vals.v1 !== '' ? createLabel(200, 20, `V1=${getText('v1')}`, vColor) : ''}
            ${vals.i1 !== '' ? createLabel(200, 70, `I1=${getText('i1')}`, iColor) : ''}

            <!-- Resistor 2 (Right Side) -->
            <line x1="340" y1="100" x2="340" y2="150" stroke="#1e293b" stroke-width="10" />
            <polyline points="340,100 350,105 330,115 350,125 330,135 340,140 340,150" class="resistor" fill="none"/>
            ${vals.v2 !== '' ? createLabel(370, 125, `V2=${getText('v2')}`, vColor) : ''}
            ${vals.i2 !== '' ? createLabel(310, 125, `I2=${getText('i2')}`, iColor) : ''}
        </svg>`;
    }

    function getParallelSVG(vals, unknownKey) {
        const getText = (key) => key === unknownKey ? `?` : `${vals[key]}`;
        const vColor = "#f59e0b"; const iColor = "#c4b5fd"; const battColor = "#ef4444";

        return `
        <svg viewBox="0 0 400 250">
            <line x1="80" y1="40" x2="320" y2="40" class="wire" />
            <line x1="80" y1="210" x2="320" y2="210" class="wire" />
            <line x1="80" y1="40" x2="80" y2="210" class="wire" />
            <line x1="80" y1="90" x2="80" y2="160" stroke="#1e293b" stroke-width="10" />
            <line x1="65" y1="100" x2="95" y2="100" class="battery" />
            <line x1="72" y1="115" x2="88" y2="115" class="battery" />
            <line x1="65" y1="130" x2="95" y2="130" class="battery" />
            <line x1="72" y1="145" x2="88" y2="145" class="battery" />
            
            ${vals.vt !== '' ? createLabel(40, 125, `VT=${getText('vt')}`, battColor) : ''}
            ${vals.it !== '' ? createLabel(110, 25, `IT=${getText('it')}`, iColor) : ''}

            <line x1="200" y1="40" x2="200" y2="210" class="wire" />
            <line x1="200" y1="90" x2="200" y2="160" stroke="#1e293b" stroke-width="10" />
            <polyline points="200,90 210,95 190,105 210,115 190,125 210,135 190,145 200,150" class="resistor" fill="none"/>
            ${vals.v1 !== '' ? createLabel(240, 125, `V1=${getText('v1')}`, vColor) : ''}
            ${vals.i1 !== '' ? createLabel(200, 230, `I1=${getText('i1')}`, iColor) : ''}

            <line x1="320" y1="40" x2="320" y2="210" class="wire" />
            <line x1="320" y1="90" x2="320" y2="160" stroke="#1e293b" stroke-width="10" />
            <polyline points="320,90 330,95 310,105 330,115 310,125 330,135 310,145 320,150" class="resistor" fill="none"/>
            ${vals.v2 !== '' ? createLabel(360, 125, `V2=${getText('v2')}`, vColor) : ''}
            ${vals.i2 !== '' ? createLabel(320, 230, `I2=${getText('i2')}`, iColor) : ''}
        </svg>`;
    }

    function getComboSVG(vals, unknownKey) {
        // Battery -> Series R1 -> Parallel R2/R3
        const getText = (key) => key === unknownKey ? `?` : `${vals[key]}`;
        const vColor = "#f59e0b"; const iColor = "#e9d5ff"; const battColor = "#ef4444";

        return `
        <svg viewBox="0 0 500 250">
            <!-- Main Loop Wires -->
            <line x1="60" y1="50" x2="200" y2="50" class="wire" /> <!-- Top left -->
            <line x1="200" y1="50" x2="200" y2="80" class="wire" /> <!-- Drop to split -->
            
            <!-- Parallel Block -->
            <line x1="200" y1="80" x2="400" y2="80" class="wire" /> <!-- Top Parallel Rail -->
            <line x1="200" y1="200" x2="400" y2="200" class="wire" /> <!-- Bot Parallel Rail -->
            
            <!-- Branches -->
            <line x1="260" y1="80" x2="260" y2="200" class="wire" />
            <line x1="340" y1="80" x2="340" y2="200" class="wire" />

            <!-- Return Loop -->
            <line x1="200" y1="200" x2="200" y2="230" class="wire" /> 
            <line x1="60" y1="230" x2="200" y2="230" class="wire" /> 
            <line x1="60" y1="50" x2="60" y2="230" class="wire" /> 

            <!-- Battery -->
            <line x1="60" y1="110" x2="60" y2="170" stroke="#1e293b" stroke-width="10" />
            <line x1="45" y1="120" x2="75" y2="120" class="battery" />
            <line x1="52" y1="135" x2="68" y2="135" class="battery" />
            <line x1="45" y1="150" x2="75" y2="150" class="battery" />
            ${vals.vt !== '' ? createLabel(30, 140, `VT=${getText('vt')}`, battColor) : ''}
            
            <!-- Series Resistor R1 -->
            <line x1="120" y1="50" x2="180" y2="50" stroke="#1e293b" stroke-width="10" />
            <polyline points="120,50 125,40 135,60 145,40 155,60 165,40 175,60 180,50" class="resistor" />
            ${vals.v1 !== '' ? createLabel(150, 25, `V1=${getText('v1')}`, vColor) : ''}
            ${vals.i1 !== '' ? createLabel(150, 75, `I1=${getText('i1')}`, iColor) : ''}

            <!-- Parallel Resistor R2 (Left Branch) -->
            <line x1="260" y1="110" x2="260" y2="170" stroke="#1e293b" stroke-width="10" />
            <polyline points="260,110 270,115 250,125 270,135 250,145 270,155 260,160" class="resistor" fill="none"/>
            ${vals.v2 !== '' ? createLabel(260, 100, `V2=${getText('v2')}`, vColor) : ''}
            ${vals.i2 !== '' ? createLabel(260, 220, `I2=${getText('i2')}`, iColor) : ''}

            <!-- Parallel Resistor R3 (Right Branch) -->
            <line x1="340" y1="110" x2="340" y2="170" stroke="#1e293b" stroke-width="10" />
            <polyline points="340,110 350,115 330,125 350,135 330,145 350,155 340,160" class="resistor" fill="none"/>
            ${vals.v3 !== '' ? createLabel(340, 100, `V3=${getText('v3')}`, vColor) : ''}
            ${vals.i3 !== '' ? createLabel(340, 220, `I3=${getText('i3')}`, iColor) : ''}
        </svg>`;
    }

    // --- GAME LOGIC ---
    function generateProblem() {
        // UI Reset
        document.getElementById('feedback-box').style.display = 'none';
        document.getElementById('feedback-box').className = 'feedback-area';
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('check-btn').disabled = false;
        const inputField = document.getElementById('user-input');
        inputField.value = ''; inputField.className = ''; inputField.disabled = false; inputField.focus();

        // Mode Selection: 0=Series, 1=Parallel, 2=Combination
        const rand = Math.random();
        let mode = 'series';
        if (rand > 0.33 && rand < 0.66) mode = 'parallel';
        else if (rand >= 0.66) mode = 'combination';

        const isVoltage = Math.random() > 0.5;
        
        let targetKey, targetVal, label, unit, explanation, svgHTML;
        let vals = {};

        if (mode === 'combination') {
            // COMBO LOGIC: Series R1 + Parallel (R2 || R3)
            // Current Rule: I_total = I1, I1 = I2 + I3
            // Voltage Rule: V_total = V1 + V_parallel (and V2=V3=V_parallel)

            if (isVoltage) {
                // Voltage Problem
                const v_par = Math.floor(Math.random() * 5) + 5; // Parallel voltage (V2=V3)
                const v_ser = Math.floor(Math.random() * 5) + 5; // Series voltage (V1)
                const v_tot = v_par + v_ser;
                
                const qType = Math.random();
                if (qType < 0.33) {
                    // Find V_total given V1 and V2
                    vals = { vt: '?', v1: v_ser, v2: v_par, v3: '', i1:'', i2:'', i3:'' };
                    targetKey = 'vt'; targetVal = v_tot; unit = 'V'; label = 'V<sub>T</sub>';
                    explanation = `<strong>Logic:</strong> In this mixed circuit, the total voltage is shared.<br>$V_T = V_1 + V_{parallel}$<br>Since $V_2$ is in the parallel part, $V_{parallel} = V_2$.<br>$V_T = ${v_ser} + ${v_par} = ${v_tot}V$`;
                } else if (qType < 0.66) {
                    // Find V2 given V3
                    vals = { vt: '', v1: '', v2: '?', v3: v_par, i1:'', i2:'', i3:'' };
                    targetKey = 'v2'; targetVal = v_par; unit = 'V'; label = 'V<sub>2</sub>';
                    explanation = `<strong>Logic:</strong> $R_2$ and $R_3$ are in <strong>Parallel</strong>.<br>Parallel components always have the <strong>SAME</strong> voltage.<br>$V_2 = V_3 = ${v_par}V$`;
                } else {
                     // Find V1 given V_total and V2
                     vals = { vt: v_tot, v1: '?', v2: v_par, v3: '', i1:'', i2:'', i3:'' };
                     targetKey = 'v1'; targetVal = v_ser; unit = 'V'; label = 'V<sub>1</sub>';
                     explanation = `<strong>Logic:</strong> The total voltage is split between the Series part ($R_1$) and the Parallel part ($R_2/R_3$).<br>$V_1 = V_T - V_{parallel}$<br>$V_1 = ${v_tot} - ${v_par} = ${v_ser}V$`;
                }
            } else {
                // Current Problem
                const i2 = Math.floor(Math.random() * 4) + 1;
                const i3 = Math.floor(Math.random() * 4) + 1;
                const i1 = i2 + i3; // Total current enters split
                
                const qType = Math.random();
                if (qType < 0.5) {
                    // Find I1 given I2 and I3
                    vals = { vt: '', v1: '', v2: '', v3: '', i1:'?', i2: i2, i3: i3 };
                    targetKey = 'i1'; targetVal = i1; unit = 'A'; label = 'I<sub>1</sub>';
                    explanation = `<strong>Logic:</strong> $I_1$ is the current entering the junction.<br>It splits into $I_2$ and $I_3$.<br>$I_1 = I_2 + I_3 = ${i2} + ${i3} = ${i1}A$`;
                } else {
                    // Find I3 given I1 and I2
                    vals = { vt: '', v1: '', v2: '', v3: '', i1: i1, i2: i2, i3: '?' };
                    targetKey = 'i3'; targetVal = i3; unit = 'A'; label = 'I<sub>3</sub>';
                    explanation = `<strong>Logic:</strong> $I_1$ splits into $I_2$ and $I_3$.<br>So, $I_3 = I_1 - I_2$<br>$I_3 = ${i1} - ${i2} = ${i3}A$`;
                }
            }
            svgHTML = getComboSVG(vals, targetKey);
            
            // Set Style
            document.getElementById('mode-badge').innerText = `COMBINATION CIRCUIT`;
            document.getElementById('mode-badge').style.color = 'var(--purple)';
            document.body.className = 'combo-mode';

        } else if (mode === 'series') {
            // Existing Series Logic
            const valA = Math.floor(Math.random() * 8) + 2; const valB = Math.floor(Math.random() * 8) + 2; 
            if (isVoltage) {
                let total = valA + valB;
                let unknown = Math.random();
                if(unknown<0.33) { targetKey='vt'; targetVal=total; explanation=`Series: Voltage adds up. $V_1 + V_2 = V_T$`; vals={vt:'?',v1:valA,v2:valB,it:'',i1:'',i2:''};}
                else { targetKey='v1'; targetVal=valA; explanation=`Series: $V_1 = V_T - V_2$`; vals={vt:total,v1:'?',v2:valB,it:'',i1:'',i2:''};}
                unit="V"; label=targetKey.toUpperCase().replace('T','<sub>T</sub>').replace('1','<sub>1</sub>');
            } else {
                targetKey='it'; targetVal=valA; explanation=`Series: Current is constant everywhere.`; vals={vt:'',v1:'',v2:'',it:'?',i1:valA,i2:valA};
                unit="A"; label="I<sub>T</sub>";
            }
            svgHTML = getSeriesSVG(vals, targetKey);
            document.getElementById('mode-badge').innerText = `SERIES CIRCUIT`;
            document.getElementById('mode-badge').style.color = 'var(--primary)';
            document.body.className = 'series-mode';

        } else {
            // Existing Parallel Logic
            const valA = Math.floor(Math.random() * 8) + 2; const valB = Math.floor(Math.random() * 8) + 2; 
            if (isVoltage) {
                targetKey='v2'; targetVal=valA; explanation=`Parallel: Voltage is the same everywhere.`; vals={vt:valA,v1:valA,v2:'?',it:'',i1:'',i2:''};
                unit="V"; label="V<sub>2</sub>";
            } else {
                let total = valA + valB;
                let unknown = Math.random();
                if(unknown<0.33) { targetKey='it'; targetVal=total; explanation=`Parallel: Current adds up. $I_1 + I_2 = I_T$`; vals={vt:'',v1:'',v2:'',it:'?',i1:valA,i2:valB};}
                else { targetKey='i1'; targetVal=valA; explanation=`Parallel: $I_1 = I_T - I_2$`; vals={vt:'',v1:'',v2:'',it:total,i1:'?',i2:valB};}
                unit="A"; label=targetKey.toUpperCase().replace('T','<sub>T</sub>').replace('1','<sub>1</sub>');
            }
            svgHTML = getParallelSVG(vals, targetKey);
            document.getElementById('mode-badge').innerText = `PARALLEL CIRCUIT`;
            document.getElementById('mode-badge').style.color = 'var(--accent)';
            document.body.className = 'parallel-mode';
        }

        currentProblem = { targetVal: targetVal, explanation: explanation, unit: unit };
        document.getElementById('input-label').innerHTML = `${label} = `; 
        document.getElementById('unit-label').innerText = unit;
        document.getElementById('circuit-canvas').innerHTML = svgHTML;
    }

    function checkAnswer() {
        if (!currentProblem) return;
        const inputField = document.getElementById('user-input');
        const userVal = parseFloat(inputField.value);
        const feedback = document.getElementById('feedback-box');
        const checkBtn = document.getElementById('check-btn');
        
        if (isNaN(userVal)) return;

        inputField.disabled = true;
        checkBtn.disabled = true;

        if (userVal === currentProblem.targetVal) {
            feedback.innerHTML = `<h3>‚úÖ Correct!</h3>The answer is <strong>${currentProblem.targetVal}${currentProblem.unit}</strong>.<br><hr style="border:0; border-top:1px solid #ddd; margin:10px 0;"> ${currentProblem.explanation}`;
            feedback.className = 'feedback-area correct';
            inputField.classList.add('correct-input');
            streak++;
        } else {
            feedback.innerHTML = `<h3>‚ùå Not quite.</h3>The correct answer is <strong>${currentProblem.targetVal}${currentProblem.unit}</strong>.<br><hr style="border:0; border-top:1px solid #faa; margin:10px 0;"> ${currentProblem.explanation}`;
            feedback.className = 'feedback-area wrong';
            inputField.classList.add('wrong-input');
            streak = 0;
        }
        document.getElementById('streak-display').innerText = streak;
        document.getElementById('next-btn').style.display = 'block';
    }

    window.onload = () => { /* Start in Learn mode */ };
</script>

</body>
</html>
